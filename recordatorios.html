<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Recordatorios de hoy - Acomoda App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:linear-gradient(135deg,#2563eb 0%,#10b981 100%);color:#111827;}
    body{margin:0;padding:1rem;min-height:100vh;display:flex;align-items:center;justify-content:center;}
    .card{background:#f9fafb;padding:1.25rem;border-radius:.9rem;box-shadow:0 10px 30px rgba(0,0,0,.15);width:100%;max-width:980px;box-sizing:border-box;}
    header{display:flex;justify-content:space-between;align-items:center;gap:.75rem;border-bottom:1px solid #e5e7eb;padding-bottom:.6rem;margin-bottom:.9rem;}
    h1{margin:0;font-size:1.2rem;}
    .sub{font-size:.85rem;color:#6b7280;}
    .btn{border:none;cursor:pointer;border-radius:.55rem;padding:.55rem .8rem;font-weight:700;background:#2563eb;color:#fff;font-size:.9rem;}
    .btn:active{transform:scale(.98);}
    .btn-secondary{background:#6b7280;}
    .btn-small{padding:.35rem .6rem;font-size:.82rem;font-weight:700;}
    .row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;}
    .pill{display:inline-block;padding:.18rem .55rem;border-radius:999px;background:#e5e7eb;font-size:.82rem;color:#111827;}
    .estado{margin-top:.35rem;font-size:.85rem;color:#6b7280;}
    .estado.ok{color:#16a34a;}
    .estado.err{color:#b91c1c;}
    table{width:100%;border-collapse:collapse;margin-top:.7rem;font-size:.9rem;}
    th,td{border:1px solid #e5e7eb;padding:.45rem .5rem;text-align:left;vertical-align:top;}
    th{background:#f3f4f6;}
    .tag{font-weight:800;}
    .tag-entrada{color:#2563eb;}
    .tag-auditorio{color:#059669;}
    .muted{color:#6b7280;font-size:.82rem;}
    .acciones{display:flex;gap:.35rem;flex-wrap:wrap;}
    .box{margin-top:.8rem;padding:.8rem;border:1px solid #e5e7eb;border-radius:.75rem;background:#ffffff;}
    textarea{width:100%;min-height:90px;border:1px solid #d1d5db;border-radius:.6rem;padding:.6rem;font-size:.9rem;box-sizing:border-box;resize:vertical;}
    .hint{font-size:.82rem;color:#6b7280;margin-top:.3rem;}
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>

  <!-- ‚úÖ AUTH compat (OBLIGATORIO para reglas seguras) -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>

  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="card">
    <header>
      <div>
        <h1>üîî Recordatorios de hoy (WhatsApp)</h1>
        <div class="sub">Gener√° mensajes para las asignaciones de <span id="hoyLabel" class="pill"></span></div>
      </div>
      <div class="row">
        <button class="btn btn-secondary btn-small" type="button" onclick="volver()">‚Üê Volver</button>
        <button class="btn btn-small" type="button" onclick="cargarHoy(true)">üîÑ Recargar</button>
      </div>
    </header>

    <div class="row">
      <span class="pill">Fuente: Firebase</span>
      <span class="pill">Tel√©fonos: guardados localmente</span>
    </div>

    <div id="estado" class="estado">Cargando asignaciones...</div>

    <div class="table-wrap">
      <table id="tabla" style="display:none;">
        <thead>
          <tr>
            <th style="width:90px;">Hora</th>
            <th style="width:110px;">Rol</th>
            <th style="width:160px;">Acomodador</th>
            <th>Tel√©fono</th>
            <th style="width:280px;">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="box">
      <div class="row" style="justify-content:space-between;">
        <div>
          <strong>Mensaje modelo</strong>
          <div class="muted">Se usa al copiar / abrir WhatsApp. Pod√©s editarlo.</div>
        </div>
        <button class="btn btn-secondary btn-small" type="button" onclick="copiarMensajeModelo()">üìã Copiar modelo</button>
      </div>
      <textarea id="mensajeModelo"></textarea>
      <div class="hint">
        Nota: WhatsApp se abre con <code>wa.me</code> y el mensaje lo ‚Äúmanda‚Äù tu cuenta (no la app).
      </div>
    </div>
  </div>

<script>
  // ================== Firebase ==================
  let db = null;
  let firebaseHabilitado = false;

  // ‚úÖ Esperar a que exista un usuario autenticado
  let _resolverAuthReady;
  const authReady = new Promise((res)=> (_resolverAuthReady = res));

  try {
    const firebaseConfig = {
      apiKey: "AIzaSyDfCeqv8Nls3NIog-oRCfFFb7_AnUn9TQE",
      authDomain: "acomoda-app2.firebaseapp.com",
      projectId: "acomoda-app2",
      storageBucket: "acomoda-app2.firebasestorage.app",
      messagingSenderId: "453109433788",
      appId: "1:453109433788:web:c41f4b5eedde59f63757b9"
    };

    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    firebaseHabilitado = true;

    // ‚úÖ Persistencia local (no ‚Äúpierde‚Äù sesi√≥n)
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(()=> {
        firebase.auth().onAuthStateChanged((user)=> {
          if (user) {
            console.log("‚úÖ Auth listo:", user.uid, "anon?", user.isAnonymous);
            _resolverAuthReady(true);
            return;
          }
          firebase.auth().signInAnonymously()
            .then((cred)=> {
              console.log("‚úÖ Auth an√≥nima OK:", cred.user.uid);
              _resolverAuthReady(true);
            })
            .catch((e)=> {
              console.error("‚ùå Error auth an√≥nima:", e);
              _resolverAuthReady(false);
            });
        });
      })
      .catch((e)=> {
        console.error("‚ùå Error setPersistence:", e);
        _resolverAuthReady(false);
      });

  } catch (e) {
    console.error("Error iniciando Firebase:", e);
    firebaseHabilitado = false;
    _resolverAuthReady(false);
  }

  // ================== Utilidades ==================
  const dias = ["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];

  function hoyISO(){ return new Date().toISOString().slice(0,10); }

  function hoyLabel(){
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    return `${dias[d.getDay()]} ${dd}/${mm}/${d.getFullYear()}`;
  }

  function setEstado(texto, tipo){
    const el = document.getElementById("estado");
    el.textContent = texto;
    el.className = "estado";
    if (tipo) el.classList.add(tipo);
  }

  function getTelefonos(){
    try{
      const raw = localStorage.getItem("telefonosAcomodadores");
      if(!raw) return {};
      return JSON.parse(raw);
    }catch(e){
      console.error("Error leyendo telefonosAcomodadores:", e);
      return {};
    }
  }

  function normalizarTelefono(tel){
    return String(tel||"").replace(/[^\d]/g,"");
  }

  function getMensajeModelo(){
    return (document.getElementById("mensajeModelo").value||"").trim();
  }

  function buildMsg(asig){
    const base = getMensajeModelo();
    return base
      .replaceAll("{NOMBRE}", asig.nombre || "")
      .replaceAll("{ROL}", asig.rol || "")
      .replaceAll("{HORA}", asig.hora || "")
      .replaceAll("{FECHA}", hoyLabel());
  }

  function copiarTexto(texto){
    if(navigator.clipboard && navigator.clipboard.writeText){
      return navigator.clipboard.writeText(texto).then(()=>true).catch(()=>false);
    }
    return Promise.resolve(false);
  }

  function abrirWhatsApp(tel, texto){
    const num = normalizarTelefono(tel);
    if(!num){
      alert("Este acomodador no tiene tel√©fono cargado. Cargalo en Acomodadores > Tel√©fonos.");
      return;
    }
    const url = `https://wa.me/${num}?text=${encodeURIComponent(texto)}`;
    window.open(url, "_blank");
  }

  function volver(){
    if(history.length > 1){ history.back(); return; }
    window.location.href = "index.html";
  }

  function copiarMensajeModelo(){
    const txt = getMensajeModelo();
    copiarTexto(txt).then((ok)=> ok ? alert("‚úÖ Modelo copiado.") : prompt("Copi√° el modelo:", txt));
  }

  // ================== Render ==================
  function renderTabla(asigs){
    const tabla = document.getElementById("tabla");
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    const tels = getTelefonos();

    asigs.forEach((a)=>{
      const tr = document.createElement("tr");

      const tdHora = document.createElement("td");
      tdHora.textContent = a.hora || "";
      tr.appendChild(tdHora);

      const tdRol = document.createElement("td");
      tdRol.textContent = a.rol || "";
      tdRol.className = "tag " + (a.rol==="Entrada" ? "tag-entrada" : (a.rol==="Auditorio" ? "tag-auditorio" : ""));
      tr.appendChild(tdRol);

      const tdNom = document.createElement("td");
      tdNom.textContent = a.nombre || "";
      tr.appendChild(tdNom);

      const tel = tels[a.nombre] || "";
      const tdTel = document.createElement("td");
      tdTel.innerHTML = tel ? `<span class="pill">${tel}</span>` : `<span class="muted">Sin tel√©fono</span>`;
      tr.appendChild(tdTel);

      const tdAcc = document.createElement("td");
      const wrap = document.createElement("div");
      wrap.className = "acciones";

      const msg = buildMsg(a);

      const btnCopy = document.createElement("button");
      btnCopy.className = "btn btn-secondary btn-small";
      btnCopy.type = "button";
      btnCopy.textContent = "üìã Copiar";
      btnCopy.onclick = () => copiarTexto(msg).then((ok)=> ok ? alert("‚úÖ Mensaje copiado.") : prompt("Copi√° el mensaje:", msg));

      const btnWA = document.createElement("button");
      btnWA.className = "btn btn-small";
      btnWA.type = "button";
      btnWA.textContent = "üü¢ Abrir WhatsApp";
      btnWA.onclick = () => abrirWhatsApp(tel, msg);

      wrap.appendChild(btnCopy);
      wrap.appendChild(btnWA);
      tdAcc.appendChild(wrap);
      tr.appendChild(tdAcc);

      tbody.appendChild(tr);
    });

    tabla.style.display = asigs.length ? "table" : "none";
  }

  // ================== Carga de asignaciones ==================
  async function cargarHoy(mostrarAlertas=false){
    if(!firebaseHabilitado || !db){
      setEstado("‚ùå No se pudo conectar a Firebase.", "err");
      return;
    }

    // ‚úÖ asegurar auth antes de leer Firestore (evita permissions)
    const okAuth = await authReady;
    if(!okAuth){
      setEstado("‚ùå No se pudo autenticar (Firebase Auth).", "err");
      return;
    }

    setEstado("Buscando asignaciones de hoy...", "info");
    const fecha = hoyISO();

    try{
      const snap = await db.collection("asignaciones").where("fecha","==",fecha).get();
      const asigs = [];
      snap.forEach((doc)=> asigs.push(doc.data()));

      asigs.sort((a,b)=> String(a.hora||"").localeCompare(String(b.hora||"")) || String(a.rol||"").localeCompare(String(b.rol||"")));

      if(!asigs.length){
        renderTabla([]);
        setEstado("No hay asignaciones cargadas para hoy.", "info");
        if(mostrarAlertas) alert("No hay asignaciones para hoy.");
        return;
      }

      renderTabla(asigs);
      setEstado(`‚úÖ ${asigs.length} asignaci√≥n(es) encontrada(s) para hoy.`, "ok");
    }catch(e){
      console.error(e);
      renderTabla([]);
      setEstado("‚ùå Error leyendo asignaciones (permisos o conexi√≥n).", "err");
    }
  }

  // ================== Init ==================
  window.addEventListener("load", ()=>{
    document.getElementById("hoyLabel").textContent = hoyLabel();

    document.getElementById("mensajeModelo").value =
`Hola {NOMBRE} üëã
Recordatorio: hoy ({FECHA}) ten√©s tu asignaci√≥n como acomodador.
üïí Hora: {HORA}
üìç Rol: {ROL}

¬°Gracias!`;

    cargarHoy(false);
  });
</script>
</body>
</html>
