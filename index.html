<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Acomoda App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #2563eb 0%, #10b981 100%);
      color: #111827;
    }
    body {
      margin: 0;
      padding: 1rem;
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #f9fafb;
      padding: 1.5rem;
      border-radius: 0.9rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      max-width: 900px;
      width: 100%;
      box-sizing: border-box;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.5rem;
    }
    h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    .app-subtitle {
      font-size: 0.85rem;
      color: #6b7280;
    }
    .badge {
      background: #2563eb;
      color: #f9fafb;
      border-radius: 999px;
      padding: 0.25rem 0.7rem;
      font-size: 0.75rem;
    }
    h2 {
      font-size: 1.1rem;
      margin: 0.5rem 0 0.75rem;
    }
    h3 {
      font-size: 1rem;
      margin: 0.6rem 0;
    }
    label {
      font-size: 0.8rem;
      display: block;
      margin: 0.35rem 0 0.15rem;
    }
    input[type="password"],
    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="month"],
    select {
      width: 100%;
      padding: 0.5rem 0.6rem;
      border-radius: 0.4rem;
      border: 1px solid #d1d5db;
      font-size: 0.88rem;
      box-sizing: border-box;
      background: #ffffff;
    }
    input:focus,
    select:focus {
      outline: 2px solid #2563eb22;
      border-color: #2563eb;
    }
    .rol-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
      justify-content: center;
    }
    .rol-row label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      margin: 0;
      font-size: 0.85rem;
      cursor: pointer;
    }
    button {
      margin-top: 0.7rem;
      padding: 0.55rem 0.8rem;
      font-size: 0.9rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: 600;
    }
    button:active {
      transform: scale(0.97);
    }
    .btn-secondary {
      background: #6b7280;
    }
    .btn-danger {
      background: #dc2626;
    }
    .estado {
      margin-top: 0.4rem;
      font-size: 0.78rem;
      text-align: left;
    }
    .estado.ok {
      color: #16a34a;
    }
    .estado.err {
      color: #b91c1c;
    }
    .estado.info {
      color: #6b7280;
    }
    .small-text {
      font-size: 0.76rem;
      color: #6b7280;
    }
    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1.4fr;
      gap: 1rem;
    }
    @media (max-width: 780px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 0.9rem;
      border: 1px solid #e5e7eb;
    }
    .panel-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chip {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.8rem;
      margin-top: 0.2rem;
    }
    .tabs {
      display: flex;
      gap: 0.35rem;
      margin-bottom: 0.5rem;
      margin-top: 0.4rem;
      flex-wrap: wrap;
    }
    .tab-btn {
      flex: 1;
      padding: 0.35rem;
      font-size: 0.78rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #e5e7eb;
      cursor: pointer;
      text-align: center;
    }
    .tab-btn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      margin-top: 0.3rem;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 0.25rem 0.3rem;
      text-align: left;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }
    .empty-text {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 0.4rem;
    }
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="card">
    <header>
      <div>
        <h1>ACOMODA APP</h1>
        <div class="app-subtitle">Programa mensual, acomodadores y recordatorios</div>
      </div>
      <div style="display:flex; align-items:center; gap:0.5rem;">
        <span class="badge">v6 Firebase</span>
        <!-- Botón salir: al inicio oculto -->
        <button id="btnSalir" class="btn-secondary" type="button"
                style="display:none; font-size:0.8rem; padding:0.3rem 0.6rem;"
                onclick="cerrarSesion()">
          Salir
        </button>
      </div>
    </header>

    <!-- LOGIN -->
    <div id="loginSection" class="panel">
      <div class="panel-title">
        <h2>Ingreso</h2>
      </div>
      <p class="small-text">
        Elegí tu rol e ingresá tu PIN. El PIN de coordinador es interno (999) y no se muestra en pantalla.
      </p>

      <div class="rol-row">
        <label>
          <input type="radio" name="rol" value="coordinador" />
          Coordinador
        </label>
        <label>
          <input type="radio" name="rol" value="acomodador" />
          Acomodador
        </label>
      </div>

      <label for="pinInput">PIN</label>
      <input id="pinInput" type="password" placeholder="Ingrese su PIN" />

      <button onclick="entrar()">Entrar</button>

      <div id="estadoConexion" class="estado info"></div>

      <div style="margin-top:0.5rem;">
        <button class="btn-secondary" type="button" onclick="probarFirebase()">
          Probar conexión con Firebase
        </button>
        <div id="resultadoFirebase" class="small-text"></div>
      </div>
    </div>

    <!-- APP LOGGED -->
    <div id="appSection" style="display:none;">
      <div class="layout">
        <!-- Columna izquierda: info usuario + administración -->
        <div>
          <div class="panel">
            <div class="panel-title">
              <h2>Usuario</h2>
            </div>
            <div id="infoUsuario" class="chip"></div>
            <div id="infoExtraUsuario" class="small-text" style="margin-top:0.25rem;"></div>
          </div>

          <!-- Panel Coordinador: Acomodadores + Config -->
          <div id="panelCoordinadorLateral" class="panel" style="margin-top:0.7rem; display:none;">
            <div class="panel-title">
              <h2>Administración</h2>
            </div>
            <div class="tabs">
              <button class="tab-btn active" id="tabAcom" onclick="cambiarTabAdmin('acom')">
                Acomodadores
              </button>
              <button class="tab-btn" id="tabConfig" onclick="cambiarTabAdmin('config')">
                Config. reuniones
              </button>
            </div>

            <!-- Tab Acomodadores -->
            <div id="tabAdminAcom">
              <h3>Lista de acomodadores</h3>
              <table>
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>PIN</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tablaAcomodadores"></tbody>
              </table>
              <div id="sinAcomodadores" class="empty-text" style="display:none;">
                No hay acomodadores cargados.
              </div>

              <h3 style="margin-top:0.7rem;">Agregar acomodador</h3>
              <label for="nuevoNombreAcom">Nombre</label>
              <input id="nuevoNombreAcom" type="text" placeholder="Ej: Pedro" />

              <label for="nuevoPinAcom">PIN</label>
              <input id="nuevoPinAcom" type="text" placeholder="Ej: 1111" />

              <button type="button" onclick="agregarAcomodador()">Guardar acomodador</button>
              <div id="estadoAcomodadores" class="estado"></div>
            </div>

            <!-- Tab Config reuniones -->
            <div id="tabAdminConfig" style="display:none;">
              <h3>Días y horario de reuniones</h3>
              <p class="small-text">
                Estos datos son de referencia para el programa mensual (no cambian las asignaciones ya cargadas).
              </p>
              <label>Días de reunión</label>
              <div>
                <label class="small-text">
                  <input type="checkbox" id="diaMiercoles" /> Miércoles
                </label>
                <label class="small-text">
                  <input type="checkbox" id="diaSabado" /> Sábado
                </label>
              </div>

              <label for="horaReunion">Hora habitual</label>
              <input id="horaReunion" type="time" />

              <button type="button" onclick="guardarConfigReuniones()">Guardar configuración</button>
              <div id="estadoConfig" class="estado"></div>

              <div style="margin-top:0.5rem;">
                <span class="small-text">Resumen:</span>
                <div id="resumenConfigReuniones" class="small-text"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Columna derecha: menús + paneles -->
        <div>
          <!-- MENÚ COORDINADOR -->
          <div id="menuCoordinador" class="panel" style="display:none;">
            <div class="panel-title">
              <h2>Menú coordinador</h2>
            </div>
            <p class="small-text">
              Elegí qué sección querés usar.
            </p>
            <button type="button" onclick="abrirSeccionCoordinador('programa')">
              Programa mensual y reemplazos
            </button>
          </div>

          <!-- MENÚ ACOMODADOR -->
          <div id="menuAcomodador" class="panel" style="display:none;">
            <div class="panel-title">
              <h2>Menú acomodador</h2>
            </div>
            <p class="small-text">
              Elegí qué querés hacer.
            </p>
            <button type="button" onclick="abrirSeccionAcomodador('asig')">
              Ver mis asignaciones
            </button>
            <button type="button" onclick="abrirSeccionAcomodador('reemplazo')">
              Necesito reemplazo
            </button>
          </div>

          <!-- Panel Coordinador: Programa mensual + reemplazos -->
          <div id="panelCoordinadorPrincipal" class="panel" style="display:none;">
            <div class="panel-title">
              <h2>Programa mensual</h2>
              <button type="button" class="btn-secondary" style="font-size:0.75rem; padding:0.25rem 0.5rem;"
                      onclick="volverMenuCoordinador()">
                ← Menú coordinador
              </button>
            </div>

            <label for="mesPrograma">Mes</label>
            <input id="mesPrograma" type="month" onchange="renderProgramaMensual()" />

            <h3 style="margin-top:0.5rem;">Agregar asignación</h3>
            <div class="small-text">
              Seleccioná fecha, hora, rol y acomodador. Se guarda en la nube y se muestra en el programa.
            </div>

            <label for="asigFecha">Fecha</label>
            <input type="date" id="asigFecha" />

            <label for="asigHora">Hora</label>
            <input type="time" id="asigHora" />

            <label for="asigRol">Rol</label>
            <select id="asigRol">
              <option value="">Seleccione rol</option>
              <option value="Entrada">Entrada</option>
              <option value="Auditorio">Auditorio</option>
            </select>

            <label for="asigAcomodador">Acomodador</label>
            <select id="asigAcomodador">
              <option value="">Seleccione</option>
            </select>

            <button type="button" onclick="guardarAsignacion()">Guardar asignación</button>
            <div id="estadoAsignacion" class="estado"></div>

            <h3 style="margin-top:0.7rem;">Asignaciones del mes</h3>
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th>Rol</th>
                  <th>Acomodador</th>
                  <th>PIN</th>
                </tr>
              </thead>
              <tbody id="tablaProgramaMensual"></tbody>
            </table>
            <div id="sinAsignacionesMes" class="empty-text" style="display:none;">
              No hay asignaciones cargadas para este mes.
            </div>

            <h3 style="margin-top:0.7rem;">Pedidos de reemplazo</h3>
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th>Rol</th>
                  <th>Nombre</th>
                  <th>PIN</th>
                </tr>
              </thead>
              <tbody id="tablaReemplazos"></tbody>
            </table>
            <div id="sinReemplazos" class="empty-text" style="display:none;">
              No hay pedidos de reemplazo.
            </div>
          </div>

          <!-- Panel Acomodador -->
          <div id="panelAcomodador" class="panel" style="display:none;">
            <div class="panel-title">
              <h2>Acomodador</h2>
              <button type="button" class="btn-secondary" style="font-size:0.75rem; padding:0.25rem 0.5rem;"
                      onclick="volverMenuAcomodador()">
                ← Menú acomodador
              </button>
            </div>
            <div class="tabs">
              <button class="tab-btn active" id="tabMisAsig" onclick="cambiarTabAcomodador('asig')">
                Mis asignaciones
              </button>
              <button class="tab-btn" id="tabReemplazo" onclick="cambiarTabAcomodador('reemplazo')">
                Necesito reemplazo
              </button>
            </div>

            <!-- Mis asignaciones -->
            <div id="tabAcomodadorAsignaciones">
              <div id="listaAsignacionesAcomodador" class="empty-text">
                Cargando asignaciones...
              </div>
              <div class="small-text" style="margin-top:0.3rem;">
                Si tu app está abierta y permitiste notificaciones, el día de tu asignación te llega un recordatorio a la hora indicada.
              </div>
            </div>

            <!-- Necesito reemplazo -->
            <div id="tabAcomodadorReemplazo" style="display:none;">
              <h3>Pedido de reemplazo</h3>
              <label for="reempFecha">Fecha de la asignación</label>
              <input type="date" id="reempFecha" />

              <button type="button" onclick="buscarAsignacionParaReemplazo()">Buscar mi asignación</button>

              <div id="detalleReemplazo" class="empty-text" style="margin-top:0.4rem;">
                Seleccioná la fecha y buscá tu asignación.
              </div>

              <button type="button" id="btnConfirmarReemplazo" style="display:none;" onclick="confirmarReemplazo()">
                Enviar pedido de reemplazo
              </button>

              <div id="estadoReemplazo" class="estado"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Firebase ---
    let db = null;
    let firebaseHabilitado = false;
    let asignacionesTodas = [];
    let timersNotificaciones = [];

    try {
      const firebaseConfig = {
        apiKey: "AIzaSyDfCeqv8Nls3NIog-oRCfFFb7_AnUn9TQE",
        authDomain: "acomoda-app2.firebaseapp.com",
        projectId: "acomoda-app2",
        storageBucket: "acomoda-app2.firebasestorage.app",
        messagingSenderId: "453109433788",
        appId: "1:453109433788:web:c41f4b5eedde59f63757b9"
      };
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      firebaseHabilitado = true;
      console.log("✅ Firebase habilitado (modo nube).");
    } catch (e) {
      console.log("❌ Error inicializando Firebase:", e);
    }

    window.addEventListener("load", () => {
      const estadoEl = document.getElementById("estadoConexion");
      if (firebaseHabilitado) {
        estadoEl.textContent = "Conectado a Firebase (modo nube).";
      } else {
        estadoEl.textContent = "No se pudo conectar a Firebase. Modo local.";
      }

      // Mes actual por defecto en el programa
      const mesInput = document.getElementById("mesPrograma");
      const hoy = new Date();
      const mesStr = hoy.toISOString().slice(0, 7); // YYYY-MM
      if (mesInput) mesInput.value = mesStr;
    });

    // --- Usuario actual ---
    const PIN_COORDINADOR = "999";
    let usuarioRol = null;
    let usuarioPin = null;
    let usuarioNombre = null;
    let asignacionSeleccionadaParaReemplazo = null;

    function entrar() {
      const rolEl = document.querySelector('input[name="rol"]:checked');
      const pin = document.getElementById("pinInput").value.trim();

      if (!rolEl) {
        alert("Seleccione si es Coordinador o Acomodador.");
        return;
      }
      if (!pin) {
        alert("Ingrese su PIN.");
        return;
      }

      const rol = rolEl.value;

      if (rol === "coordinador") {
        if (pin !== PIN_COORDINADOR) {
          alert("PIN de coordinador incorrecto.");
          return;
        }
        usuarioRol = "coordinador";
        usuarioPin = pin;
        usuarioNombre = "Coordinador";
        mostrarAppCoordinador();
      } else {
        // Acomodador: buscar en colección 'acomodadores'
        if (!firebaseHabilitado || !db) {
          alert("No se pudo conectar a la nube. No se puede validar el PIN.");
          return;
        }
        db.collection("acomodadores")
          .where("pin", "==", pin)
          .limit(1)
          .get()
          .then((snapshot) => {
            if (snapshot.empty) {
              alert("PIN de acomodador no registrado.");
              return;
            }
            const doc = snapshot.docs[0];
            const data = doc.data();
            usuarioRol = "acomodador";
            usuarioPin = pin;
            usuarioNombre = data.nombre || "Acomodador";
            mostrarAppAcomodador();
          })
          .catch((error) => {
            console.error("Error validando acomodador:", error);
            alert("Error validando PIN de acomodador.");
          });
      }
    }

    function mostrarAppCoordinador() {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("appSection").style.display = "block";

      // Mostrar solo menú coordinador al inicio
      document.getElementById("menuCoordinador").style.display = "block";
      document.getElementById("menuAcomodador").style.display = "none";
      document.getElementById("panelCoordinadorLateral").style.display = "block";
      document.getElementById("panelCoordinadorPrincipal").style.display = "none";
      document.getElementById("panelAcomodador").style.display = "none";

      document.getElementById("infoUsuario").textContent = "Coordinador (PIN 999)";
      document.getElementById("infoExtraUsuario").textContent =
        "Puede gestionar acomodadores, configurar reuniones y cargar el programa mensual.";

      // mostrar botón salir
      const btnSalir = document.getElementById("btnSalir");
      if (btnSalir) btnSalir.style.display = "inline-block";

      escucharAcomodadores();
      escucharAsignacionesCoordinador();
      escucharReemplazosCoordinador();
      cargarConfigReuniones();
    }

    function mostrarAppAcomodador() {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("appSection").style.display = "block";

      // Mostrar menú acomodador al inicio
      document.getElementById("menuCoordinador").style.display = "none";
      document.getElementById("menuAcomodador").style.display = "block";
      document.getElementById("panelCoordinadorLateral").style.display = "none";
      document.getElementById("panelCoordinadorPrincipal").style.display = "none";
      document.getElementById("panelAcomodador").style.display = "none";

      document.getElementById("infoUsuario").textContent =
        usuarioNombre + " | PIN " + usuarioPin;
      document.getElementById("infoExtraUsuario").textContent =
        "Elegí una opción en el menú. Luego podés volver aquí cuando quieras.";

      // botón salir visible
      const btnSalir = document.getElementById("btnSalir");
      if (btnSalir) btnSalir.style.display = "inline-block";

      escucharAsignacionesAcomodador(usuarioPin);
      solicitarPermisoNotificaciones();
    }

    // --- Menús y navegación ---
    function abrirSeccionCoordinador(seccion) {
      document.getElementById("menuCoordinador").style.display = "none";

      if (seccion === "programa") {
        document.getElementById("panelCoordinadorPrincipal").style.display = "block";
      }
    }

    function volverMenuCoordinador() {
      document.getElementById("panelCoordinadorPrincipal").style.display = "none";
      document.getElementById("menuCoordinador").style.display = "block";
    }

    function abrirSeccionAcomodador(seccion) {
      document.getElementById("menuAcomodador").style.display = "none";
      document.getElementById("panelAcomodador").style.display = "block";
      cambiarTabAcomodador(seccion);
    }

    function volverMenuAcomodador() {
      document.getElementById("panelAcomodador").style.display = "none";
      document.getElementById("menuAcomodador").style.display = "block";
    }

    function cerrarSesion() {
      // limpiar variables
      usuarioRol = null;
      usuarioPin = null;
      usuarioNombre = null;
      asignacionSeleccionadaParaReemplazo = null;

      // limpiar entrada
      document.getElementById("pinInput").value = "";
      const radios = document.querySelectorAll('input[name="rol"]');
      radios.forEach(r => (r.checked = false));

      document.getElementById("infoUsuario").textContent = "";
      document.getElementById("infoExtraUsuario").textContent = "";

      // ocultar todo menos el login
      document.getElementById("appSection").style.display = "none";
      document.getElementById("loginSection").style.display = "block";

      document.getElementById("panelCoordinadorLateral").style.display = "none";
      document.getElementById("panelCoordinadorPrincipal").style.display = "none";
      document.getElementById("panelAcomodador").style.display = "none";
      document.getElementById("menuCoordinador").style.display = "none";
      document.getElementById("menuAcomodador").style.display = "none";

      // ocultar botón salir
      const btnSalir = document.getElementById("btnSalir");
      if (btnSalir) btnSalir.style.display = "none";

      // cancelar notificaciones programadas
      timersNotificaciones.forEach(id => clearTimeout(id));
      timersNotificaciones = [];
    }

    // --- Tabs admin (coordinador) ---
    function cambiarTabAdmin(tab) {
      const btnAcom = document.getElementById("tabAcom");
      const btnConfig = document.getElementById("tabConfig");
      const divAcom = document.getElementById("tabAdminAcom");
      const divConfig = document.getElementById("tabAdminConfig");

      if (tab === "acom") {
        btnAcom.classList.add("active");
        btnConfig.classList.remove("active");
        divAcom.style.display = "block";
        divConfig.style.display = "none";
      } else {
        btnAcom.classList.remove("active");
        btnConfig.classList.add("active");
        divAcom.style.display = "none";
        divConfig.style.display = "block";
      }
    }

    // --- Tabs acomodador ---
    function cambiarTabAcomodador(tab) {
      const btnAsig = document.getElementById("tabMisAsig");
      const btnReemp = document.getElementById("tabReemplazo");
      const tabAsig = document.getElementById("tabAcomodadorAsignaciones");
      const tabReemp = document.getElementById("tabAcomodadorReemplazo");

      if (tab === "asig") {
        btnAsig.classList.add("active");
        btnReemp.classList.remove("active");
        tabAsig.style.display = "block";
        tabReemp.style.display = "none";
      } else {
        btnAsig.classList.remove("active");
        btnReemp.classList.add("active");
        tabAsig.style.display = "none";
        tabReemp.style.display = "block";
      }
    }

    // --- Probar conexión Firebase ---
    function probarFirebase() {
      if (!firebaseHabilitado || !db) {
        alert("Firebase no está habilitado.");
        return;
      }
      db.collection("pruebas")
        .add({
          mensaje: "Hola desde AcomodaApp",
          fecha: new Date().toISOString()
        })
        .then(() => {
          document.getElementById("resultadoFirebase").textContent =
            "✅ Se guardó un documento de prueba en 'pruebas'.";
        })
        .catch((error) => {
          console.error("Error prueba Firebase:", error);
          document.getElementById("resultadoFirebase").textContent =
            "❌ Error al guardar el documento de prueba.";
        });
    }

    // --- Acomodadores (Coordinador) ---
    function escucharAcomodadores() {
      if (!firebaseHabilitado || !db) return;

      db.collection("acomodadores")
        .orderBy("nombre")
        .onSnapshot((snapshot) => {
          const tbody = document.getElementById("tablaAcomodadores");
          const sinEl = document.getElementById("sinAcomodadores");
          const selectAcom = document.getElementById("asigAcomodador");

          tbody.innerHTML = "";
          selectAcom.innerHTML = '<option value="">Seleccione</option>';

          if (snapshot.empty) {
            sinEl.style.display = "block";
            return;
          } else {
            sinEl.style.display = "none";
          }

          snapshot.forEach((doc) => {
            const data = doc.data();
            const tr = document.createElement("tr");

            const tdNombre = document.createElement("td");
            tdNombre.textContent = data.nombre || "";
            tr.appendChild(tdNombre);

            const tdPin = document.createElement("td");
            tdPin.textContent = data.pin || "";
            tr.appendChild(tdPin);

            const tdAcc = document.createElement("td");
            const btnDel = document.createElement("button");
            btnDel.textContent = "✕";
            btnDel.className = "btn-danger";
            btnDel.style.fontSize = "0.7rem";
            btnDel.style.padding = "0.2rem 0.4rem";
            btnDel.onclick = () => eliminarAcomodador(doc.id);
            tdAcc.appendChild(btnDel);
            tr.appendChild(tdAcc);

            tbody.appendChild(tr);

            // Opción para el select
            const opt = document.createElement("option");
            opt.value = data.pin;
            opt.textContent = data.nombre + " (PIN " + data.pin + ")";
            selectAcom.appendChild(opt);
          });
        });
    }

    function agregarAcomodador() {
      const nombre = document.getElementById("nuevoNombreAcom").value.trim();
      const pin = document.getElementById("nuevoPinAcom").value.trim();
      const estadoEl = document.getElementById("estadoAcomodadores");

      estadoEl.textContent = "";
      estadoEl.className = "estado";

      if (!firebaseHabilitado || !db) {
        estadoEl.textContent = "No se pudo conectar a la nube.";
        estadoEl.classList.add("err");
        return;
      }
      if (!nombre || !pin) {
        estadoEl.textContent = "Complete nombre y PIN.";
        estadoEl.classList.add("err");
        return;
      }

      // Verificar que el PIN no se repita
      db.collection("acomodadores")
        .where("pin", "==", pin)
        .get()
        .then((snap) => {
          if (!snap.empty) {
            estadoEl.textContent = "Ya existe un acomodador con ese PIN.";
            estadoEl.classList.add("err");
            return;
          }
          return db.collection("acomodadores").add({
            nombre: nombre,
            pin: pin
          });
        })
        .then((res) => {
          if (!res) return;
          estadoEl.textContent = "✅ Acomodador guardado.";
          estadoEl.classList.add("ok");
          document.getElementById("nuevoNombreAcom").value = "";
          document.getElementById("nuevoPinAcom").value = "";
        })
        .catch((error) => {
          console.error("Error agregando acomodador:", error);
          estadoEl.textContent = "❌ Error al guardar acomodador.";
          estadoEl.classList.add("err");
        });
    }

    function eliminarAcomodador(id) {
      if (!confirm("¿Eliminar este acomodador?")) return;
      if (!firebaseHabilitado || !db) return;

      db.collection("acomodadores")
        .doc(id)
        .delete()
        .catch((error) => {
          console.error("Error eliminando acomodador:", error);
        });
    }

    // --- Config reuniones ---
    function cargarConfigReuniones() {
      if (!firebaseHabilitado || !db) return;

      db.collection("config")
        .doc("reuniones")
        .get()
        .then((doc) => {
          const diaMi = document.getElementById("diaMiercoles");
          const diaSa = document.getElementById("diaSabado");
          const horaR = document.getElementById("horaReunion");
          const resumen = document.getElementById("resumenConfigReuniones");

          if (!doc.exists) {
            resumen.textContent = "Sin configuración guardada.";
            return;
          }
          const data = doc.data();
          diaMi.checked = !!data.miercoles;
          diaSa.checked = !!data.sabado;
          if (data.hora) horaR.value = data.hora;

          let texto = "";
          const dias = [];
          if (data.miercoles) dias.push("Miércoles");
          if (data.sabado) dias.push("Sábado");
          if (dias.length) {
            texto += "Días: " + dias.join(", ") + ". ";
          }
          if (data.hora) texto += "Hora: " + data.hora;
          resumen.textContent = texto || "Sin configuración guardada.";
        })
        .catch((error) => {
          console.error("Error cargando config reuniones:", error);
        });
    }

    function guardarConfigReuniones() {
      const diaMi = document.getElementById("diaMiercoles").checked;
      const diaSa = document.getElementById("diaSabado").checked;
      const horaR = document.getElementById("horaReunion").value;
      const estadoEl = document.getElementById("estadoConfig");

      estadoEl.textContent = "";
      estadoEl.className = "estado";

      if (!firebaseHabilitado || !db) {
        estadoEl.textContent = "No se pudo conectar a la nube.";
        estadoEl.classList.add("err");
        return;
      }

      db.collection("config")
        .doc("reuniones")
        .set(
          {
            miercoles: diaMi,
            sabado: diaSa,
            hora: horaR || null
          },
          { merge: true }
        )
        .then(() => {
          estadoEl.textContent = "✅ Configuración guardada.";
          estadoEl.classList.add("ok");
          cargarConfigReuniones();
        })
        .catch((error) => {
          console.error("Error guardando config reuniones:", error);
          estadoEl.textContent = "❌ Error al guardar.";
          estadoEl.classList.add("err");
        });
    }

    // --- Asignaciones (Coordinador) ---
    function guardarAsignacion() {
      const fecha = document.getElementById("asigFecha").value;
      const hora = document.getElementById("asigHora").value;
      const rol = document.getElementById("asigRol").value;
      const pinSeleccionado = document.getElementById("asigAcomodador").value;
      const estadoEl = document.getElementById("estadoAsignacion");

      estadoEl.textContent = "";
      estadoEl.className = "estado";

      if (!firebaseHabilitado || !db) {
        estadoEl.textContent = "No se pudo conectar a la nube.";
        estadoEl.classList.add("err");
        return;
      }

      if (!fecha || !hora || !rol || !pinSeleccionado) {
        estadoEl.textContent = "Complete todos los campos.";
        estadoEl.classList.add("err");
        return;
      }

      // Buscar nombre del acomodador por PIN
      db.collection("acomodadores")
        .where("pin", "==", pinSeleccionado)
        .limit(1)
        .get()
        .then((snap) => {
          if (snap.empty) throw new Error("No se encontró acomodador para ese PIN.");
          const data = snap.docs[0].data();
          const nombre = data.nombre || "";
          return db.collection("asignaciones").add({
            fecha: fecha,
            hora: hora,
            rol: rol,
            nombre: nombre,
            pin: pinSeleccionado,
            creadoEn: new Date().toISOString()
          });
        })
        .then(() => {
          estadoEl.textContent = "✅ Asignación guardada.";
          estadoEl.classList.add("ok");
        })
        .catch((error) => {
          console.error("Error guardando asignación:", error);
          estadoEl.textContent = "❌ Error al guardar la asignación.";
          estadoEl.classList.add("err");
        });
    }

    function escucharAsignacionesCoordinador() {
      if (!firebaseHabilitado || !db) return;

      db.collection("asignaciones")
        .orderBy("fecha")
        .onSnapshot((snapshot) => {
          asignacionesTodas = [];
          snapshot.forEach((doc) => {
            asignacionesTodas.push({ id: doc.id, ...doc.data() });
          });
          renderProgramaMensual();
        });
    }

    function renderProgramaMensual() {
      const mesInput = document.getElementById("mesPrograma");
      const tbody = document.getElementById("tablaProgramaMensual");
      const sinEl = document.getElementById("sinAsignacionesMes");

      tbody.innerHTML = "";
      if (!mesInput) return;

      const mes = mesInput.value; // YYYY-MM
      if (!mes) {
        sinEl.style.display = "block";
        return;
      }

      const asignFiltradas = asignacionesTodas.filter((a) =>
        (a.fecha || "").startsWith(mes)
      );

      if (!asignFiltradas.length) {
        sinEl.style.display = "block";
        return;
      } else {
        sinEl.style.display = "none";
      }

      asignFiltradas.sort((a, b) => (a.fecha || "").localeCompare(b.fecha || ""));

      asignFiltradas.forEach((data) => {
        const tr = document.createElement("tr");

        const tdFecha = document.createElement("td");
        tdFecha.textContent = data.fecha || "";
        tr.appendChild(tdFecha);

        const tdHora = document.createElement("td");
        tdHora.textContent = data.hora || "";
        tr.appendChild(tdHora);

        const tdRol = document.createElement("td");
        tdRol.textContent = data.rol || "";
        tr.appendChild(tdRol);

        const tdNombre = document.createElement("td");
        tdNombre.textContent = data.nombre || "";
        tr.appendChild(tdNombre);

        const tdPin = document.createElement("td");
        tdPin.textContent = data.pin || "";
        tr.appendChild(tdPin);

        tbody.appendChild(tr);
      });
    }

    // --- Asignaciones (Acomodador) ---
    function escucharAsignacionesAcomodador(pin) {
      if (!firebaseHabilitado || !db) {
        document.getElementById("listaAsignacionesAcomodador").textContent =
          "No se pudo conectar a la nube.";
        return;
      }

      db.collection("asignaciones")
        .where("pin", "==", pin)
        .onSnapshot((snapshot) => {
          const cont = document.getElementById("listaAsignacionesAcomodador");

          if (snapshot.empty) {
            cont.textContent = "No tenés asignaciones cargadas todavía.";
            return;
          }

          const asignaciones = [];
          let html = "<ul style='padding-left: 1rem; margin:0;'>";
          snapshot.forEach((doc) => {
            const data = doc.data();
            asignaciones.push(data);
            html += `<li>${data.fecha || ""} ${data.hora || ""} - ${data.rol || ""}</li>`;
          });
          html += "</ul>";
          cont.innerHTML = html;

          programarNotificacionesAsignaciones(asignaciones);
        });
    }

    // --- Reemplazos (Acomodador) ---
    function buscarAsignacionParaReemplazo() {
      const fecha = document.getElementById("reempFecha").value;
      const detalle = document.getElementById("detalleReemplazo");
      const btn = document.getElementById("btnConfirmarReemplazo");
      const estado = document.getElementById("estadoReemplazo");

      detalle.textContent = "";
      btn.style.display = "none";
      estado.textContent = "";
      estado.className = "estado";

      if (!fecha) {
        detalle.textContent = "Seleccione una fecha.";
        return;
      }
      if (!firebaseHabilitado || !db) {
        detalle.textContent = "No se pudo conectar a la nube.";
        return;
      }

      db.collection("asignaciones")
        .where("pin", "==", usuarioPin)
        .where("fecha", "==", fecha)
        .get()
        .then((snapshot) => {
          if (snapshot.empty) {
            detalle.textContent = "No tenés asignación en esa fecha.";
            asignacionSeleccionadaParaReemplazo = null;
            return;
          }
          const doc = snapshot.docs[0];
          const data = doc.data();
          asignacionSeleccionadaParaReemplazo = {
            id: doc.id,
            ...data
          };
          detalle.textContent =
            "Asignación: " +
            (data.fecha || "") +
            " " +
            (data.hora || "") +
            " - " +
            (data.rol || "") +
            " (" +
            (data.nombre || "") +
            ")";
          btn.style.display = "inline-block";
        })
        .catch((error) => {
          console.error("Error buscando asignación:", error);
          detalle.textContent = "Error al buscar la asignación.";
        });
    }

    function confirmarReemplazo() {
      const estado = document.getElementById("estadoReemplazo");
      estado.textContent = "";
      estado.className = "estado";

      if (!asignacionSeleccionadaParaReemplazo) {
        estado.textContent = "No hay asignación seleccionada.";
        estado.classList.add("err");
        return;
      }
      if (!firebaseHabilitado || !db) {
        estado.textContent = "No se pudo conectar a la nube.";
        estado.classList.add("err");
        return;
      }

      const data = asignacionSeleccionadaParaReemplazo;
      estado.textContent = "Enviando pedido...";

      db.collection("reemplazos")
        .add({
          fecha: data.fecha,
          hora: data.hora,
          rol: data.rol,
          nombre: data.nombre,
          pin: data.pin,
          creadoEn: new Date().toISOString(),
          estado: "pendiente"
        })
        .then(() => {
          estado.textContent = "✅ Pedido de reemplazo enviado.";
          estado.classList.add("ok");
        })
        .catch((error) => {
          console.error("Error guardando reemplazo:", error);
          estado.textContent = "❌ Error al guardar el pedido.";
          estado.classList.add("err");
        });
    }

    // --- Reemplazos (Coordinador) ---
    function escucharReemplazosCoordinador() {
      if (!firebaseHabilitado || !db) return;

      db.collection("reemplazos")
        .orderBy("fecha")
        .onSnapshot((snapshot) => {
          const tbody = document.getElementById("tablaReemplazos");
          const sinEl = document.getElementById("sinReemplazos");
          tbody.innerHTML = "";

          if (snapshot.empty) {
            sinEl.style.display = "block";
            return;
          } else {
            sinEl.style.display = "none";
          }

          snapshot.forEach((doc) => {
            const data = doc.data();
            const tr = document.createElement("tr");

            const tdFecha = document.createElement("td");
            tdFecha.textContent = data.fecha || "";
            tr.appendChild(tdFecha);

            const tdHora = document.createElement("td");
            tdHora.textContent = data.hora || "";
            tr.appendChild(tdHora);

            const tdRol = document.createElement("td");
            tdRol.textContent = data.rol || "";
            tr.appendChild(tdRol);

            const tdNombre = document.createElement("td");
            tdNombre.textContent = data.nombre || "";
            tr.appendChild(tdNombre);

            const tdPin = document.createElement("td");
            tdPin.textContent = data.pin || "";
            tr.appendChild(tdPin);

            tbody.appendChild(tr);
          });
        });
    }

    // --- Notificaciones locales (opción 1) ---
    function solicitarPermisoNotificaciones() {
      if (!("Notification" in window)) {
        console.log("Este navegador no soporta notificaciones.");
        return;
      }
      if (Notification.permission === "default") {
        Notification.requestPermission().then((perm) => {
          console.log("Permiso notificaciones:", perm);
        });
      }
    }

    function programarNotificacionesAsignaciones(asignaciones) {
      if (!("Notification" in window)) return;
      if (Notification.permission !== "granted") return;

      timersNotificaciones.forEach((id) => clearTimeout(id));
      timersNotificaciones = [];

      const hoy = new Date();
      const hoyStr = hoy.toISOString().slice(0, 10);

      asignaciones.forEach((asig) => {
        if (asig.fecha !== hoyStr) return;
        if (!asig.hora) return;

        const partes = asig.hora.split(":");
        if (partes.length < 2) return;

        const hora = parseInt(partes[0], 10);
        const minuto = parseInt(partes[1], 10);

        const fechaNoti = new Date();
        fechaNoti.setHours(hora, minuto, 0, 0);

        const diff = fechaNoti.getTime() - Date.now();
        if (diff <= 0) return;
        if (diff > 24 * 60 * 60 * 1000) return;

        const timerId = setTimeout(() => {
          new Notification("Recordatorio de asignación", {
            body: `${asig.hora} - ${asig.rol} (${asig.nombre || ""})`,
          });
        }, diff);

        timersNotificaciones.push(timerId);
      });
    }
  </script>
</body>
</html>
