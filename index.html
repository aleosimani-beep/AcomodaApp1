<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Acomoda App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #2563eb 0%, #10b981 100%);
      color: #111827;
    }
    body {
      margin: 0;
      padding: 1rem;
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #f9fafb;
      padding: 1.5rem;
      border-radius: 0.9rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      max-width: 900px;
      width: 100%;
      box-sizing: border-box;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.5rem;
    }
    h1 { margin: 0; font-size: 1.5rem; }
    .app-subtitle { font-size: 0.85rem; color: #6b7280; }
    .badge {
      background: #2563eb;
      color: #f9fafb;
      border-radius: 999px;
      padding: 0.25rem 0.7rem;
      font-size: 0.75rem;
    }
    h2 { font-size: 1.1rem; margin: 0.5rem 0 0.75rem; }
    h3 { font-size: 1rem; margin: 0.6rem 0; }
    label { font-size: 0.8rem; display: block; margin: 0.35rem 0 0.15rem; }

    input[type="password"],
    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="month"],
    select {
      width: 100%;
      padding: 0.5rem 0.6rem;
      border-radius: 0.4rem;
      border: 1px solid #d1d5db;
      font-size: 0.88rem;
      box-sizing: border-box;
      background: #ffffff;
    }
    input:focus, select:focus {
      outline: 2px solid #2563eb22;
      border-color: #2563eb;
    }

    .rol-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
      justify-content: center;
    }
    .rol-row label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      margin: 0;
      font-size: 0.85rem;
      cursor: pointer;
    }

    button {
      margin-top: 0.7rem;
      padding: 0.55rem 0.8rem;
      font-size: 0.9rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: 600;
    }
    button:active { transform: scale(0.97); }
    .btn-secondary { background: #6b7280; }
    .btn-danger { background: #dc2626; }
    .btn-small { font-size: 0.8rem; padding: 0.3rem 0.6rem; }

    .estado { margin-top: 0.4rem; font-size: 0.78rem; text-align: left; }
    .estado.ok { color: #16a34a; }
    .estado.err { color: #b91c1c; }
    .estado.info { color: #6b7280; }
    .small-text { font-size: 0.76rem; color: #6b7280; }

    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1.4fr;
      gap: 1rem;
    }
    @media (max-width: 780px) { .layout { grid-template-columns: 1fr; } }

    .panel {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 0.9rem;
      border: 1px solid #e5e7eb;
      margin-bottom: 0.7rem;
    }
    .panel-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .chip {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.8rem;
      margin-top: 0.2rem;
    }
    .menu-buttons { display: flex; flex-direction: column; gap: 0.4rem; margin-top: 0.4rem; }
    .menu-buttons button { width: 100%; text-align: left; }

    table { width: 100%; border-collapse: collapse; font-size: 0.78rem; margin-top: 0.3rem; }
    th, td { border: 1px solid #e5e7eb; padding: 0.25rem 0.3rem; text-align: left; vertical-align: top; }
    th { background: #f3f4f6; font-weight: 600; }
    .empty-text { font-size: 0.78rem; color: #6b7280; margin-top: 0.4rem; }

    .tr-hoy { background: #dbeafe !important; }
    .fila-miercoles { background: #fef9c3; }
    .fila-sabado { background: #dcfce7; }

    .rol-entrada { color: #2563eb; font-weight: 600; }
    .rol-auditorio { color: #059669; font-weight: 600; }

    /* Mis asignaciones - tarjetas */
    .proxima-label { font-size: 0.8rem; color: #2563eb; font-weight: 600; margin-bottom: 0.3rem; }
    .card-asig {
      border-radius: 0.6rem;
      border: 1px solid #e5e7eb;
      padding: 0.55rem 0.7rem;
      margin-top: 0.35rem;
      background: #f9fafb;
    }
    .card-asig-proxima { border-color: #2563eb; background: #eff6ff; }
    .card-asig-pasada { opacity: 0.7; }
    .card-asig-titulo { font-size: 0.86rem; font-weight: 600; margin-bottom: 0.1rem; }
    .card-asig-rol { font-size: 0.8rem; }

    /* Reemplazos - tarjetas */
    .card-reemp {
      border-radius: 0.6rem;
      border: 1px solid #e5e7eb;
      padding: 0.55rem 0.7rem;
      margin-top: 0.35rem;
      background: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }
    .card-reemp-info { font-size: 0.8rem; }

    /* Form fila horizontal */
    .form-row { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.3rem; }
    .form-field { flex: 1 1 150px; min-width: 0; }

    /* Tabla simple tel√©fonos */
    .tabla-simple {
      width: 100%;
      max-width: 500px;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    .tabla-simple th, .tabla-simple td {
      border-bottom: 1px solid #ddd;
      padding: 4px 6px;
    }
    .tabla-simple th { background-color: #f3f4f6; text-align: left; }
    .tabla-simple input {
      width: 100%;
      max-width: 180px;
      padding: 3px 6px;
      font-size: 0.85rem;
    }
    .subpanel {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: 8px;
      background-color: #f9fafb;
    }
  </style>

  <!-- Firebase compat -->
 <!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>

<!-- üîê Firebase Auth compat (OBLIGATORIO) -->
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>

<!-- Firestore compat -->
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="card">
    <header>
      <div>
        <h1>ACOMODA APP</h1>
        <div class="app-subtitle">Programa mensual, acomodadores y recordatorios</div>
      </div>
      <div style="display:flex; align-items:center; gap:0.5rem;">
        <span class="badge">v6 Firebase</span>
        <button id="btnSalir" class="btn-secondary btn-small" type="button" style="display:none;" onclick="cerrarSesion()">
          Salir
        </button>
      </div>
    </header>

    <!-- LOGIN -->
    <div id="loginSection" class="panel">
      <div class="panel-title">
        <h2>Ingreso</h2>
      </div>
      <p class="small-text">
        Eleg√≠ tu rol e ingres√° tu PIN. El PIN de coordinador es interno (999).
      </p>

      <div class="rol-row">
        <label><input type="radio" name="rol" value="coordinador" /> Coordinador</label>
        <label><input type="radio" name="rol" value="acomodador" /> Acomodador</label>
      </div>

      <label for="pinInput">PIN</label>
      <input id="pinInput" type="password" placeholder="Ingrese su PIN" />

      <button onclick="entrar()">Entrar</button>
      <div id="estadoConexion" class="estado info"></div>
    </div>

    <!-- APP LOGGED -->
    <div id="appSection" style="display:none;">
      <div class="layout">
        <!-- Columna izquierda: info usuario -->
        <div>
          <div class="panel">
            <div class="panel-title"><h2>Usuario</h2></div>
            <div id="infoUsuario" class="chip"></div>
            <div id="infoExtraUsuario" class="small-text" style="margin-top:0.25rem;"></div>
          </div>
        </div>

        <!-- Columna derecha -->
        <div>
          <!-- MEN√ö COORDINADOR -->
          <div id="menuCoordinador" class="panel" style="display:none;">
            <div class="panel-title"><h2>Men√∫ coordinador</h2></div>
            <p class="small-text">Eleg√≠ una secci√≥n.</p>
            <div class="menu-buttons">
              <button type="button" onclick="abrirSeccionCoordinador('acomodadores')">Acomodadores</button>
              <button type="button" onclick="abrirSeccionCoordinador('config')">Config. reuniones</button>
              <button type="button" onclick="abrirSeccionCoordinador('programa')">Programa mensual</button>
              <button type="button" onclick="abrirSeccionCoordinador('reemplazos')">Pedidos de reemplazo</button>
              <button type="button" onclick="window.location.href='recordatorios.html'">üîî Recordatorios de hoy (WhatsApp)</button>
            </div>
          </div>

          <!-- MEN√ö ACOMODADOR -->
          <div id="menuAcomodador" class="panel" style="display:none;">
            <div class="panel-title"><h2>Men√∫ acomodador</h2></div>
            <p class="small-text">Eleg√≠ qu√© quer√©s ver.</p>
            <div class="menu-buttons">
              <button type="button" onclick="abrirSeccionAcomodador('asig')">Ver mis asignaciones</button>
              <button type="button" onclick="abrirSeccionAcomodador('reemplazo')">Necesito reemplazo</button>
              <button type="button" onclick="abrirSeccionAcomodador('programa')">Ver programa mensual</button>
            </div>
          </div>

          <!-- PANEL COORDINADOR: ACOMODADORES -->
          <div id="panelCoordinadorAcomodadores" class="panel" style="display:none;">
            <div class="panel-title">
              <h2>Acomodadores</h2>
              <button type="button" class="btn-secondary btn-small" onclick="volverMenuCoordinador()">‚Üê Men√∫ coordinador</button>
            </div>

            <div class="subpanel">
              <h3>Tel√©fonos de acomodadores (WhatsApp)</h3>
              <p class="small-text">Carg√° o actualiz√° los tel√©fonos. Se guardan en esta computadora / celular.</p>
              <table id="tablaTelefonos" class="tabla-simple">
                <thead><tr><th>Nombre</th><th>Tel√©fono (ej: 5493512641299)</th></tr></thead>
                <tbody id="tbodyTelefonos"></tbody>
              </table>
              <button type="button" onclick="guardarTelefonosAcomodadores()">üíæ Guardar tel√©fonos</button>
            </div>

            <h3>Lista</h3>
            <table>
              <thead><tr><th>Nombre</th><th>PIN</th><th></th></tr></thead>
              <tbody id="tablaAcomodadores"></tbody>
            </table>
            <div id="sinAcomodadores" class="empty-text" style="display:none;">No hay acomodadores cargados.</div>

            <h3 style="margin-top:0.7rem;">Agregar acomodador</h3>
            <div class="form-row">
              <div class="form-field">
                <label for="nuevoNombreAcom">Nombre</label>
                <input id="nuevoNombreAcom" type="text" placeholder="Ej: Pedro" />
              </div>
              <div class="form-field">
                <label for="nuevoPinAcom">PIN</label>
                <input id="nuevoPinAcom" type="text" placeholder="Ej: 1111" />
              </div>
            </div>
            <button type="button" onclick="agregarAcomodador()">Guardar acomodador</button>
            <div id="estadoAcomodadores" class="estado"></div>
          </div>

          <!-- PANEL COORDINADOR: CONFIG -->
          <div id="panelCoordinadorConfig" class="panel" style="display:none;">
            <div class="panel-title">
              <h2>Config. reuniones</h2>
              <button type="button" class="btn-secondary btn-small" onclick="volverMenuCoordinador()">‚Üê Men√∫ coordinador</button>
            </div>
            <p class="small-text">Configur√° por separado d√≠a y hora de las reuniones (solo referencia para el programa).</p>

            <h3>Mi√©rcoles</h3>
            <label class="small-text"><input type="checkbox" id="diaMiercoles" /> Hay reuni√≥n los mi√©rcoles</label>
            <label for="horaMiercoles">Hora mi√©rcoles</label>
            <input id="horaMiercoles" type="time" />

            <h3 style="margin-top:0.6rem;">S√°bado</h3>
            <label class="small-text"><input type="checkbox" id="diaSabado" /> Hay reuni√≥n los s√°bados</label>
            <label for="horaSabado">Hora s√°bado</label>
            <input id="horaSabado" type="time" />

            <button type="button" onclick="guardarConfigReuniones()">Guardar configuraci√≥n</button>
            <div id="estadoConfig" class="estado"></div>

            <div style="margin-top:0.5rem;">
              <span class="small-text">Resumen:</span>
              <div id="resumenConfigReuniones" class="small-text"></div>
            </div>
          </div>

          <!-- PANEL COORDINADOR: PROGRAMA -->
          <div id="panelCoordinadorPrograma" class="panel" style="display:none;">
            <div class="panel-title">
              <div>
                <h2>Programa mensual</h2>
                <div id="tituloProgramaMes" class="small-text"></div>
              </div>
              <button type="button" class="btn-secondary btn-small" onclick="volverMenuCoordinador()">‚Üê Men√∫ coordinador</button>
            </div>

            <label for="mesPrograma">Mes</label>
            <input id="mesPrograma" type="month" onchange="renderProgramaMensual()" />

            <h3 style="margin-top:0.5rem;">Agregar asignaci√≥n</h3>
            <div class="small-text">Seleccion√° fecha, hora, rol y acomodador. Se guarda en la nube y se muestra abajo.</div>

            <div class="form-row">
              <div class="form-field"><label for="asigFecha">Fecha</label><input type="date" id="asigFecha" /></div>
              <div class="form-field"><label for="asigHora">Hora</label><input type="time" id="asigHora" /></div>
              <div class="form-field">
                <label for="asigRol">Rol</label>
                <select id="asigRol">
                  <option value="">Seleccione</option>
                  <option value="Entrada">Entrada</option>
                  <option value="Auditorio">Auditorio</option>
                </select>
              </div>
              <div class="form-field">
                <label for="asigAcomodador">Acomodador</label>
                <select id="asigAcomodador"><option value="">Seleccione</option></select>
              </div>
            </div>

            <button type="button" onclick="guardarAsignacion()">Guardar asignaci√≥n</button>
            <div id="estadoAsignacion" class="estado"></div>

            <h3 style="margin-top:0.7rem;">Asignaciones del mes</h3>
            <table>
              <thead><tr><th>Fecha</th><th>Acomodador 1</th><th>Asignaci√≥n</th><th>Acomodador 2</th><th>Asignaci√≥n</th></tr></thead>
              <tbody id="tablaProgramaMensual"></tbody>
            </table>
            <div id="sinAsignacionesMes" class="empty-text" style="display:none;">No hay asignaciones cargadas para este mes.</div>
          </div>

          <!-- PANEL COORDINADOR: REEMPLAZOS -->
          <div id="panelCoordinadorReemplazos" class="panel" style="display:none;">
            <div class="panel-title">
              <h2>Pedidos de reemplazo</h2>
              <button type="button" class="btn-secondary btn-small" onclick="volverMenuCoordinador()">‚Üê Men√∫ coordinador</button>
            </div>

            <div class="small-text">Tip: us√° <strong>üìã Copiar</strong> y pegalo directo en el grupo.</div>

            <table>
              <thead>
                <tr><th>Fecha</th><th>Hora</th><th>Rol</th><th>Nombre</th><th>PIN</th><th>Acci√≥n</th></tr>
              </thead>
              <tbody id="tablaReemplazos"></tbody>
            </table>
            <div id="sinReemplazos" class="empty-text" style="display:none;">No hay pedidos de reemplazo.</div>
          </div>

          <!-- PANEL ACOMODADOR: MIS ASIGNACIONES -->
          <div id="panelAcomodadorAsignaciones" class="panel" style="display:none;">
            <div class="panel-title">
              <h2>Mis asignaciones</h2>
              <button type="button" class="btn-secondary btn-small" onclick="volverMenuAcomodador()">‚Üê Men√∫ acomodador</button>
            </div>
            <div id="listaAsignacionesAcomodador" class="empty-text">Cargando asignaciones...</div>
            <div class="small-text" style="margin-top:0.3rem;">
              Si la app est√° abierta y aceptaste notificaciones, el d√≠a de tu asignaci√≥n te llega un recordatorio a la hora indicada.
            </div>
          </div>

          <!-- PANEL ACOMODADOR: REEMPLAZO -->
          <div id="panelAcomodadorReemplazo" class="panel" style="display:none;">
            <div class="panel-title">
              <h2>Necesito reemplazo</h2>
              <button type="button" class="btn-secondary btn-small" onclick="volverMenuAcomodador()">‚Üê Men√∫ acomodador</button>
            </div>

            <p class="small-text">Eleg√≠ en la lista para cu√°l asignaci√≥n quer√©s pedir reemplazo.</p>
            <div id="listaReemplazoOpciones" class="empty-text">No ten√©s asignaciones pr√≥ximas para pedir reemplazo.</div>

            <div id="detalleReemplazo" class="empty-text" style="margin-top:0.4rem;">Ninguna asignaci√≥n seleccionada todav√≠a.</div>

            <button type="button" id="btnConfirmarReemplazo" style="display:none;" onclick="confirmarReemplazo()">
              Enviar pedido de reemplazo
            </button>

            <div class="small-text" style="margin-top:0.4rem;">
              Al enviar, se guardar√° el pedido y se abrir√° WhatsApp para avisar al coordinador.
            </div>

            <div id="estadoReemplazo" class="estado"></div>
          </div>

          <!-- PANEL ACOMODADOR: PROGRAMA -->
          <div id="panelAcomodadorPrograma" class="panel" style="display:none;">
            <div class="panel-title">
              <h2>Programa mensual</h2>
              <button type="button" class="btn-secondary btn-small" onclick="volverMenuAcomodador()">‚Üê Men√∫ acomodador</button>
            </div>

            <label for="mesProgramaAcom">Mes</label>
            <input id="mesProgramaAcom" type="month" onchange="renderProgramaMensualAcomodador()" />

            <h3 style="margin-top:0.5rem;">Asignaciones del mes</h3>
            <table>
              <thead><tr><th>Fecha</th><th>Acomodador 1</th><th>Asignaci√≥n</th><th>Acomodador 2</th><th>Asignaci√≥n</th></tr></thead>
              <tbody id="tablaProgramaMensualAcom"></tbody>
            </table>
            <div id="sinAsignacionesMesAcom" class="empty-text" style="display:none;">No hay asignaciones cargadas para este mes.</div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
  // ================== CONFIG WHATSAPP (Coordinador) ==================
  // Tu n√∫mero (sin +, sin espacios). Ej: 5493517481053
  const COORDINADOR_WA = "5493517481053";

  // ================== Utilidades ==================
  const diasSemanaCortos = ["Dom", "Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b"];
  const diasSemanaLargo = ["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];
  const mesesNombre = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];

  function formatearFechaConDia(fechaStr) {
    if (!fechaStr) return "";
    const date = new Date(fechaStr + "T00:00:00");
    if (isNaN(date)) return fechaStr;
    const dia = diasSemanaCortos[date.getDay()];
    const dd = String(date.getDate()).padStart(2,"0");
    const mm = String(date.getMonth() + 1).padStart(2,"0");
    return `${dia} ${dd}/${mm}`;
  }

  function formatearFechaPlanilla(fechaStr) {
    if (!fechaStr) return "";
    const date = new Date(fechaStr + "T00:00:00");
    if (isNaN(date)) return fechaStr;
    const diaNombre = diasSemanaLargo[date.getDay()];
    const num = date.getDate();
    return `${diaNombre} ${num}`;
  }

  function buildMensajeReemplazoParaWa(data) {
    const fechaForm = formatearFechaConDia(data.fecha || "");
    const hora = data.hora || "";
    const rol = data.rol || "";
    const nombre = data.nombre || "Acomodador";
    return `Hola! Necesito reemplazo.\n\nüìå ${fechaForm} ${hora}\nRol: ${rol}\nSolicita: ${nombre}\n\n¬øQui√©n puede cubrir?`;
  }

  function abrirWhatsAppANumero(numero, mensaje) {
    const url = `https://wa.me/${numero}?text=${encodeURIComponent(mensaje)}`;
    window.open(url, "_blank");
  }

  async function copiarAlPortapapeles(texto) {
    try {
      await navigator.clipboard.writeText(texto);
      alert("‚úÖ Mensaje copiado. Pegalo en el grupo de WhatsApp.");
    } catch (e) {
      prompt("Copi√° y peg√° este mensaje:", texto);
    }
  }

  // ================== Tel√©fonos de acomodadores (localStorage) ==================
  let listaAcomodadoresFirebase = [];

  function obtenerTelefonosGuardados() {
    try {
      const raw = localStorage.getItem("telefonosAcomodadores");
      if (!raw) return {};
      return JSON.parse(raw);
    } catch (e) {
      console.error("Error leyendo telefonosAcomodadores:", e);
      return {};
    }
  }

  function guardarTelefonosAcomodadores() {
    const tbody = document.getElementById("tbodyTelefonos");
    if (!tbody) return;

    const filas = tbody.querySelectorAll("tr");
    const datos = {};

    filas.forEach((fila) => {
      const nombre = fila.querySelector("td input[data-tipo='nombre']").value.trim();
      const tel = fila.querySelector("td input[data-tipo='telefono']").value.trim();
      if (nombre) datos[nombre] = tel;
    });

    localStorage.setItem("telefonosAcomodadores", JSON.stringify(datos));
    alert("Tel√©fonos de acomodadores guardados.");
  }

  function inicializarTablaTelefonos() {
    const tbody = document.getElementById("tbodyTelefonos");
    if (!tbody) return;

    const guardados = obtenerTelefonosGuardados();
    tbody.innerHTML = "";

    (listaAcomodadoresFirebase || []).forEach((nombre) => {
      const tr = document.createElement("tr");

      const tdNombre = document.createElement("td");
      const inputNombre = document.createElement("input");
      inputNombre.type = "text";
      inputNombre.value = nombre;
      inputNombre.dataset.tipo = "nombre";
      tdNombre.appendChild(inputNombre);

      const tdTelefono = document.createElement("td");
      const inputTel = document.createElement("input");
      inputTel.type = "text";
      inputTel.placeholder = "549351....";
      inputTel.value = guardados[nombre] || "";
      inputTel.dataset.tipo = "telefono";
      tdTelefono.appendChild(inputTel);

      tr.appendChild(tdNombre);
      tr.appendChild(tdTelefono);
      tbody.appendChild(tr);
    });
  }

  // ================== Firebase ==================
 // ================== Firebase ==================
let db = null;
let firebaseHabilitado = false;
let asignacionesTodas = [];
let asignacionesAcomodador = [];
let timersNotificaciones = [];

try {
  const firebaseConfig = {
    apiKey: "AIzaSyDfCeqv8Nls3NIog-oRCfFFb7_AnUn9TQE",
    authDomain: "acomoda-app2.firebaseapp.com",
    projectId: "acomoda-app2",
    storageBucket: "acomoda-app2.firebasestorage.app",
    messagingSenderId: "453109433788",
    appId: "1:453109433788:web:c41f4b5eedde59f63757b9"
  };

  // 1Ô∏è‚É£ Inicializa Firebase
  firebase.initializeApp(firebaseConfig);

  // 2Ô∏è‚É£ üîê AUTH AN√ìNIMA (ESTO ES LO NUEVO)
  firebase.auth().signInAnonymously()
    .then((cred) => {
      console.log("‚úÖ Auth an√≥nima OK. UID:", cred.user.uid);
    })
    .catch((error) => {
      console.error("‚ùå Error auth an√≥nima:", error);
    });

  // 3Ô∏è‚É£ Firestore
  db = firebase.firestore();
  firebaseHabilitado = true;

  console.log("‚úÖ Firebase habilitado (modo nube).");

} catch (e) {
  console.log("‚ùå Error inicializando Firebase:", e);
}

  window.addEventListener("load", () => {
    const estadoEl = document.getElementById("estadoConexion");
    estadoEl.textContent = firebaseHabilitado ? "Conectado a Firebase (modo nube)." : "No se pudo conectar a Firebase. Modo local.";

    const hoy = new Date();
    const mesStr = hoy.toISOString().slice(0, 7);
    const mesInput = document.getElementById("mesPrograma");
    if (mesInput) mesInput.value = mesStr;
    const mesInputAcom = document.getElementById("mesProgramaAcom");
    if (mesInputAcom) mesInputAcom.value = mesStr;

    actualizarTituloProgramaMes();
  });

  // ================== Usuario actual ==================
  const PIN_COORDINADOR = "999";
  let usuarioRol = null;
  let usuarioPin = null;
  let usuarioNombre = null;
  let asignacionSeleccionadaParaReemplazo = null;

  function entrar() {
    const rolEl = document.querySelector('input[name="rol"]:checked');
    const pin = document.getElementById("pinInput").value.trim();

    if (!rolEl) return alert("Seleccione si es Coordinador o Acomodador.");
    if (!pin) return alert("Ingrese su PIN.");

    const rol = rolEl.value;

    if (rol === "coordinador") {
      if (pin !== PIN_COORDINADOR) return alert("PIN de coordinador incorrecto.");
      usuarioRol = "coordinador";
      usuarioPin = pin;
      usuarioNombre = "Coordinador";
      mostrarAppCoordinador();
    } else {
      if (!firebaseHabilitado || !db) return alert("No se pudo conectar a la nube. No se puede validar el PIN.");
      db.collection("acomodadores").where("pin", "==", pin).limit(1).get()
        .then((snapshot) => {
          if (snapshot.empty) return alert("PIN de acomodador no registrado.");
          const data = snapshot.docs[0].data();
          usuarioRol = "acomodador";
          usuarioPin = pin;
          usuarioNombre = data.nombre || "Acomodador";
          mostrarAppAcomodador();
        })
        .catch((error) => {
          console.error("Error validando acomodador:", error);
          alert("Error validando PIN de acomodador.");
        });
    }
  }

  function mostrarAppCoordinador() {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("appSection").style.display = "block";
    document.getElementById("menuCoordinador").style.display = "block";
    document.getElementById("menuAcomodador").style.display = "none";
    ocultarPanelesCoordinador();
    ocultarPanelesAcomodador();

    document.getElementById("infoUsuario").textContent = "Coordinador (PIN 999)";
    document.getElementById("infoExtraUsuario").textContent = "Puede gestionar acomodadores, configurar reuniones y cargar el programa mensual.";

    const btnSalir = document.getElementById("btnSalir");
    if (btnSalir) btnSalir.style.display = "inline-block";

    escucharAcomodadores();
    escucharAsignacionesGlobal();
    escucharReemplazosCoordinador();
    cargarConfigReuniones();
  }

  function mostrarAppAcomodador() {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("appSection").style.display = "block";
    document.getElementById("menuCoordinador").style.display = "none";
    document.getElementById("menuAcomodador").style.display = "block";
    ocultarPanelesCoordinador();
    ocultarPanelesAcomodador();

    document.getElementById("infoUsuario").textContent = "Acomodador: " + usuarioNombre;
    document.getElementById("infoExtraUsuario").textContent = "Eleg√≠ una opci√≥n en el men√∫. No se muestra tu PIN por seguridad visual.";

    const btnSalir = document.getElementById("btnSalir");
    if (btnSalir) btnSalir.style.display = "inline-block";

    escucharAsignacionesGlobal();
    escucharAsignacionesAcomodador(usuarioPin);
    solicitarPermisoNotificaciones();
  }

  function ocultarPanelesCoordinador() {
    document.getElementById("panelCoordinadorAcomodadores").style.display = "none";
    document.getElementById("panelCoordinadorConfig").style.display = "none";
    document.getElementById("panelCoordinadorPrograma").style.display = "none";
    document.getElementById("panelCoordinadorReemplazos").style.display = "none";
  }
  function ocultarPanelesAcomodador() {
    document.getElementById("panelAcomodadorAsignaciones").style.display = "none";
    document.getElementById("panelAcomodadorReemplazo").style.display = "none";
    document.getElementById("panelAcomodadorPrograma").style.display = "none";
  }

  function abrirSeccionCoordinador(seccion) {
    ocultarPanelesCoordinador();
    if (seccion === "acomodadores") {
      document.getElementById("panelCoordinadorAcomodadores").style.display = "block";
      inicializarTablaTelefonos();
    } else if (seccion === "config") {
      document.getElementById("panelCoordinadorConfig").style.display = "block";
    } else if (seccion === "programa") {
      document.getElementById("panelCoordinadorPrograma").style.display = "block";
      actualizarTituloProgramaMes();
      renderProgramaMensual();
    } else if (seccion === "reemplazos") {
      document.getElementById("panelCoordinadorReemplazos").style.display = "block";
    }
  }
  function volverMenuCoordinador() { ocultarPanelesCoordinador(); document.getElementById("menuCoordinador").style.display = "block"; }

  function abrirSeccionAcomodador(seccion) {
    ocultarPanelesAcomodador();
    document.getElementById("menuAcomodador").style.display = "none";
    if (seccion === "asig") document.getElementById("panelAcomodadorAsignaciones").style.display = "block";
    else if (seccion === "reemplazo") document.getElementById("panelAcomodadorReemplazo").style.display = "block";
    else if (seccion === "programa") {
      document.getElementById("panelAcomodadorPrograma").style.display = "block";
      renderProgramaMensualAcomodador();
    }
  }
  function volverMenuAcomodador() { ocultarPanelesAcomodador(); document.getElementById("menuAcomodador").style.display = "block"; }

  function cerrarSesion() {
    usuarioRol = null; usuarioPin = null; usuarioNombre = null;
    asignacionSeleccionadaParaReemplazo = null; asignacionesAcomodador = [];
    document.getElementById("pinInput").value = "";
    document.querySelectorAll('input[name="rol"]').forEach(r => (r.checked = false));
    document.getElementById("infoUsuario").textContent = "";
    document.getElementById("infoExtraUsuario").textContent = "";
    document.getElementById("appSection").style.display = "none";
    document.getElementById("loginSection").style.display = "block";
    document.getElementById("menuCoordinador").style.display = "none";
    document.getElementById("menuAcomodador").style.display = "none";
    ocultarPanelesCoordinador(); ocultarPanelesAcomodador();
    const btnSalir = document.getElementById("btnSalir");
    if (btnSalir) btnSalir.style.display = "none";
    timersNotificaciones.forEach(id => clearTimeout(id));
    timersNotificaciones = [];
  }

  // ================== Acomodadores (Coordinador) ==================
  function escucharAcomodadores() {
    if (!firebaseHabilitado || !db) return;

    db.collection("acomodadores").orderBy("nombre").onSnapshot((snapshot) => {
      const tbody = document.getElementById("tablaAcomodadores");
      const sinEl = document.getElementById("sinAcomodadores");
      const selectAcom = document.getElementById("asigAcomodador");

      tbody.innerHTML = "";
      selectAcom.innerHTML = '<option value="">Seleccione</option>';
      listaAcomodadoresFirebase = [];

      if (snapshot.empty) {
        sinEl.style.display = "block";
        inicializarTablaTelefonos();
        return;
      } else {
        sinEl.style.display = "none";
      }

      snapshot.forEach((doc) => {
        const data = doc.data();
        const nombre = data.nombre || "";
        if (nombre) listaAcomodadoresFirebase.push(nombre);

        const tr = document.createElement("tr");
        const tdNombre = document.createElement("td"); tdNombre.textContent = nombre; tr.appendChild(tdNombre);
        const tdPin = document.createElement("td"); tdPin.textContent = data.pin || ""; tr.appendChild(tdPin);

        const tdAcc = document.createElement("td");
        const btnDel = document.createElement("button");
        btnDel.textContent = "‚úï";
        btnDel.className = "btn-danger btn-small";
        btnDel.onclick = () => eliminarAcomodador(doc.id);
        tdAcc.appendChild(btnDel);
        tr.appendChild(tdAcc);
        tbody.appendChild(tr);

        const opt = document.createElement("option");
        opt.value = data.pin;
        opt.textContent = nombre + " (PIN " + data.pin + ")";
        selectAcom.appendChild(opt);
      });

      inicializarTablaTelefonos();
    });
  }

  function agregarAcomodador() {
    const nombre = document.getElementById("nuevoNombreAcom").value.trim();
    const pin = document.getElementById("nuevoPinAcom").value.trim();
    const estadoEl = document.getElementById("estadoAcomodadores");
    estadoEl.textContent = ""; estadoEl.className = "estado";

    if (!firebaseHabilitado || !db) { estadoEl.textContent = "No se pudo conectar a la nube."; estadoEl.classList.add("err"); return; }
    if (!nombre || !pin) { estadoEl.textContent = "Complete nombre y PIN."; estadoEl.classList.add("err"); return; }

    db.collection("acomodadores").where("pin", "==", pin).get()
      .then((snap) => {
        if (!snap.empty) { estadoEl.textContent = "Ya existe un acomodador con ese PIN."; estadoEl.classList.add("err"); return; }
        return db.collection("acomodadores").add({ nombre, pin });
      })
      .then((res) => {
        if (!res) return;
        estadoEl.textContent = "‚úÖ Acomodador guardado.";
        estadoEl.classList.add("ok");
        document.getElementById("nuevoNombreAcom").value = "";
        document.getElementById("nuevoPinAcom").value = "";
      })
      .catch((error) => {
        console.error("Error agregando acomodador:", error);
        estadoEl.textContent = "‚ùå Error al guardar acomodador.";
        estadoEl.classList.add("err");
      });
  }

  function eliminarAcomodador(id) {
    if (!confirm("¬øEliminar este acomodador?")) return;
    if (!firebaseHabilitado || !db) return;
    db.collection("acomodadores").doc(id).delete().catch((error) => console.error("Error eliminando acomodador:", error));
  }

  // ================== Config reuniones ==================
  function cargarConfigReuniones() {
    if (!firebaseHabilitado || !db) return;

    db.collection("config").doc("reuniones").get()
      .then((doc) => {
        const diaMi = document.getElementById("diaMiercoles");
        const horaMi = document.getElementById("horaMiercoles");
        const diaSa = document.getElementById("diaSabado");
        const horaSa = document.getElementById("horaSabado");
        const resumen = document.getElementById("resumenConfigReuniones");

        if (!doc.exists) { resumen.textContent = "Sin configuraci√≥n guardada."; return; }
        const data = doc.data();
        diaMi.checked = !!data.miercoles;
        diaSa.checked = !!data.sabado;
        if (data.horaMiercoles) horaMi.value = data.horaMiercoles;
        if (data.horaSabado) horaSa.value = data.horaSabado;

        const partes = [];
        if (data.miercoles) partes.push("Mi√©rcoles" + (data.horaMiercoles ? " " + data.horaMiercoles : ""));
        if (data.sabado) partes.push("S√°bado" + (data.horaSabado ? " " + data.horaSabado : ""));
        resumen.textContent = partes.length ? partes.join(" | ") : "Sin configuraci√≥n guardada.";
      })
      .catch((error) => console.error("Error cargando config reuniones:", error));
  }

  function guardarConfigReuniones() {
    const diaMi = document.getElementById("diaMiercoles").checked;
    const horaMi = document.getElementById("horaMiercoles").value;
    const diaSa = document.getElementById("diaSabado").checked;
    const horaSa = document.getElementById("horaSabado").value;
    const estadoEl = document.getElementById("estadoConfig");
    estadoEl.textContent = ""; estadoEl.className = "estado";

    if (!firebaseHabilitado || !db) { estadoEl.textContent = "No se pudo conectar a la nube."; estadoEl.classList.add("err"); return; }

    db.collection("config").doc("reuniones").set(
      { miercoles: diaMi, horaMiercoles: diaMi ? (horaMi || null) : null, sabado: diaSa, horaSabado: diaSa ? (horaSa || null) : null },
      { merge: true }
    )
    .then(() => { estadoEl.textContent = "‚úÖ Configuraci√≥n guardada."; estadoEl.classList.add("ok"); cargarConfigReuniones(); })
    .catch((error) => { console.error("Error guardando config reuniones:", error); estadoEl.textContent = "‚ùå Error al guardar."; estadoEl.classList.add("err"); });
  }

  // ================== Asignaciones ==================
  function guardarAsignacion() {
    const fecha = document.getElementById("asigFecha").value;
    const hora = document.getElementById("asigHora").value;
    const rol = document.getElementById("asigRol").value;
    const pinSeleccionado = document.getElementById("asigAcomodador").value;
    const estadoEl = document.getElementById("estadoAsignacion");
    estadoEl.textContent = ""; estadoEl.className = "estado";

    if (!firebaseHabilitado || !db) { estadoEl.textContent = "No se pudo conectar a la nube."; estadoEl.classList.add("err"); return; }
    if (!fecha || !hora || !rol || !pinSeleccionado) { estadoEl.textContent = "Complete todos los campos."; estadoEl.classList.add("err"); return; }

    db.collection("acomodadores").where("pin", "==", pinSeleccionado).limit(1).get()
      .then((snap) => {
        if (snap.empty) throw new Error("No se encontr√≥ acomodador para ese PIN.");
        const data = snap.docs[0].data();
        const nombre = data.nombre || "";
        return db.collection("asignaciones").add({ fecha, hora, rol, nombre, pin: pinSeleccionado, creadoEn: new Date().toISOString() });
      })
      .then(() => { estadoEl.textContent = "‚úÖ Asignaci√≥n guardada."; estadoEl.classList.add("ok"); })
      .catch((error) => { console.error("Error guardando asignaci√≥n:", error); estadoEl.textContent = "‚ùå Error al guardar la asignaci√≥n."; estadoEl.classList.add("err"); });
  }

  function escucharAsignacionesGlobal() {
    if (!firebaseHabilitado || !db) return;
    db.collection("asignaciones").orderBy("fecha").onSnapshot((snapshot) => {
      asignacionesTodas = [];
      snapshot.forEach((doc) => asignacionesTodas.push({ id: doc.id, ...doc.data() }));
      renderProgramaMensual();
      renderProgramaMensualAcomodador();
    });
  }

  function obtenerGruposPorFecha(asignaciones, mes) {
    if (!mes) return [];
    const grupos = {};
    asignaciones.forEach((a) => {
      const fecha = a.fecha || "";
      if (!fecha.startsWith(mes)) return;
      if (!grupos[fecha]) grupos[fecha] = { fecha, entrada: [], auditorio: [] };
      if (a.rol === "Entrada") grupos[fecha].entrada.push(a);
      else if (a.rol === "Auditorio") grupos[fecha].auditorio.push(a);
    });
    return Object.keys(grupos).sort().map((k) => grupos[k]);
  }

  function actualizarTituloProgramaMes() {
    const mesInput = document.getElementById("mesPrograma");
    const titulo = document.getElementById("tituloProgramaMes");
    if (!mesInput || !titulo) return;
    const mes = mesInput.value;
    if (!mes) return (titulo.textContent = "");
    const partes = mes.split("-");
    if (partes.length !== 2) return (titulo.textContent = "");
    const year = partes[0];
    const m = parseInt(partes[1], 10);
    const nombreMes = mesesNombre[m - 1] || "";
    titulo.textContent = `Programa de ${nombreMes} ${year}`;
  }

  function renderProgramaMensual() {
    const mesInput = document.getElementById("mesPrograma");
    const tbody = document.getElementById("tablaProgramaMensual");
    const sinEl = document.getElementById("sinAsignacionesMes");
    if (!mesInput || !tbody || !sinEl) return;

    const mes = mesInput.value;
    const hoyStr = new Date().toISOString().slice(0,10);
    tbody.innerHTML = "";

    const grupos = obtenerGruposPorFecha(asignacionesTodas, mes);
    if (!grupos.length) { sinEl.style.display = "block"; return; }
    sinEl.style.display = "none";

    grupos.forEach((g) => {
      const tr = document.createElement("tr");
      const d = new Date(g.fecha + "T00:00:00");
      const dow = d.getDay();
      if (dow === 3) tr.classList.add("fila-miercoles");
      if (dow === 6) tr.classList.add("fila-sabado");
      if (g.fecha === hoyStr) tr.classList.add("tr-hoy");

      const entradaNombres = g.entrada.map(x => x.nombre || "").join(", ");
      const auditorioNombres = g.auditorio.map(x => x.nombre || "").join(", ");

      const tdFecha = document.createElement("td"); tdFecha.textContent = formatearFechaPlanilla(g.fecha); tr.appendChild(tdFecha);
      const tdAcom1 = document.createElement("td"); tdAcom1.textContent = entradaNombres || ""; tr.appendChild(tdAcom1);
      const tdRol1 = document.createElement("td"); tdRol1.textContent = entradaNombres ? "Entrada" : ""; tr.appendChild(tdRol1);
      const tdAcom2 = document.createElement("td"); tdAcom2.textContent = auditorioNombres || ""; tr.appendChild(tdAcom2);
      const tdRol2 = document.createElement("td"); tdRol2.textContent = auditorioNombres ? "Auditorio" : ""; tr.appendChild(tdRol2);

      tbody.appendChild(tr);
    });
  }

  // ================== Asignaciones (Acomodador) ==================
  function escucharAsignacionesAcomodador(pin) {
    if (!firebaseHabilitado || !db) {
      document.getElementById("listaAsignacionesAcomodador").textContent = "No se pudo conectar a la nube.";
      return;
    }

    db.collection("asignaciones").where("pin", "==", pin).onSnapshot((snapshot) => {
      const cont = document.getElementById("listaAsignacionesAcomodador");
      asignacionesAcomodador = [];

      if (snapshot.empty) {
        cont.textContent = "No ten√©s asignaciones cargadas todav√≠a.";
        document.getElementById("listaReemplazoOpciones").textContent = "No ten√©s asignaciones pr√≥ximas para pedir reemplazo.";
        return;
      }

      snapshot.forEach((doc) => asignacionesAcomodador.push(doc.data()));
      renderMisAsignaciones();
      renderOpcionesReemplazo();
      programarNotificacionesAsignaciones(asignacionesAcomodador);
    });
  }

  function renderMisAsignaciones() {
    const cont = document.getElementById("listaAsignacionesAcomodador");
    if (!cont) return;

    if (!asignacionesAcomodador.length) { cont.textContent = "No ten√©s asignaciones cargadas."; return; }

    const ahora = new Date();
    const asigs = [...asignacionesAcomodador].sort((a, b) => ((a.fecha||"") + " " + (a.hora||"")).localeCompare((b.fecha||"") + " " + (b.hora||"")));

    let html = "";
    let proximaTexto = "";
    let proximaEncontrada = false;

    asigs.forEach((a) => {
      const fhStr = (a.fecha || "") + "T" + (a.hora || "00:00") + ":00";
      const fechaObj = new Date(fhStr);
      const esFuturo = fechaObj >= ahora;
      const fechaForm = formatearFechaConDia(a.fecha || "");
      const rol = a.rol || "";

      let clases = "card-asig";
      if (esFuturo && !proximaEncontrada) {
        clases += " card-asig-proxima";
        proximaEncontrada = true;
        proximaTexto = `Tu pr√≥xima asignaci√≥n: ${fechaForm} ${a.hora || ""} - ${rol}`;
      } else if (!esFuturo) {
        clases += " card-asig-pasada";
      }

      html += `
        <div class="${clases}">
          <div class="card-asig-titulo">${fechaForm} ${a.hora || ""}</div>
          <div class="card-asig-rol">Rol: ${rol}</div>
        </div>
      `;
    });

    cont.innerHTML = proximaTexto ? `<div class="proxima-label">${proximaTexto}</div>` + html : html;
  }

  function renderProgramaMensualAcomodador() {
    const mesInput = document.getElementById("mesProgramaAcom");
    const tbody = document.getElementById("tablaProgramaMensualAcom");
    const sinEl = document.getElementById("sinAsignacionesMesAcom");
    if (!mesInput || !tbody || !sinEl) return;

    const mes = mesInput.value;
    const hoyStr = new Date().toISOString().slice(0,10);
    tbody.innerHTML = "";

    const grupos = obtenerGruposPorFecha(asignacionesTodas, mes);
    if (!grupos.length) { sinEl.style.display = "block"; return; }
    sinEl.style.display = "none";

    grupos.forEach((g) => {
      const tr = document.createElement("tr");
      const d = new Date(g.fecha + "T00:00:00");
      const dow = d.getDay();
      if (dow === 3) tr.classList.add("fila-miercoles");
      if (dow === 6) tr.classList.add("fila-sabado");
      if (g.fecha === hoyStr) tr.classList.add("tr-hoy");

      const entradaNombres = g.entrada.map(x => x.nombre || "").join(", ");
      const auditorioNombres = g.auditorio.map(x => x.nombre || "").join(", ");

      const tdFecha = document.createElement("td"); tdFecha.textContent = formatearFechaPlanilla(g.fecha); tr.appendChild(tdFecha);
      const tdAcom1 = document.createElement("td"); tdAcom1.textContent = entradaNombres || ""; tr.appendChild(tdAcom1);
      const tdRol1 = document.createElement("td"); tdRol1.textContent = entradaNombres ? "Entrada" : ""; tr.appendChild(tdRol1);
      const tdAcom2 = document.createElement("td"); tdAcom2.textContent = auditorioNombres || ""; tr.appendChild(tdAcom2);
      const tdRol2 = document.createElement("td"); tdRol2.textContent = auditorioNombres ? "Auditorio" : ""; tr.appendChild(tdRol2);

      tbody.appendChild(tr);
    });
  }

  // ================== Reemplazos (Acomodador) ==================
  function renderOpcionesReemplazo() {
    const cont = document.getElementById("listaReemplazoOpciones");
    if (!cont) return;

    const hoyStr = new Date().toISOString().slice(0,10);
    const asigs = [...asignacionesAcomodador].filter(a => (a.fecha || "") >= hoyStr)
      .sort((a, b) => ((a.fecha||"") + " " + (a.hora||"")).localeCompare((b.fecha||"") + " " + (b.hora||"")));

    if (!asigs.length) { cont.textContent = "No ten√©s asignaciones pr√≥ximas para pedir reemplazo."; return; }

    let html = "";
    asigs.forEach((a, idx) => {
      const fechaForm = formatearFechaConDia(a.fecha || "");
      const rol = a.rol || "";
      html += `
        <div class="card-reemp">
          <div class="card-reemp-info">
            <div><strong>${fechaForm}</strong> ${a.hora || ""}</div>
            <div>Rol: ${rol}</div>
          </div>
          <button type="button" class="btn-secondary btn-small" onclick="seleccionarReemplazo(${idx})">Pedir reemplazo</button>
        </div>
      `;
    });

    cont.innerHTML = html;
  }

  function seleccionarReemplazo(idx) {
    const hoyStr = new Date().toISOString().slice(0,10);
    const asigs = [...asignacionesAcomodador].filter(a => (a.fecha || "") >= hoyStr)
      .sort((a, b) => ((a.fecha||"") + " " + (a.hora||"")).localeCompare((b.fecha||"") + " " + (b.hora||"")));

    if (idx < 0 || idx >= asigs.length) return;

    asignacionSeleccionadaParaReemplazo = asigs[idx];
    const detalle = document.getElementById("detalleReemplazo");
    const btn = document.getElementById("btnConfirmarReemplazo");

    const a = asignacionSeleccionadaParaReemplazo;
    const fechaForm = formatearFechaConDia(a.fecha || "");
    detalle.textContent = `Asignaci√≥n seleccionada: ${fechaForm} ${a.hora || ""} - ${a.rol || ""}${a.nombre ? " (" + a.nombre + ")" : ""}`;

    btn.style.display = "inline-block";
    const estado = document.getElementById("estadoReemplazo");
    estado.textContent = "";
    estado.className = "estado";
  }

  function confirmarReemplazo() {
    const estado = document.getElementById("estadoReemplazo");
    estado.textContent = "";
    estado.className = "estado";

    if (!asignacionSeleccionadaParaReemplazo) { estado.textContent = "No hay asignaci√≥n seleccionada."; estado.classList.add("err"); return; }
    if (!firebaseHabilitado || !db) { estado.textContent = "No se pudo conectar a la nube."; estado.classList.add("err"); return; }

    const data = asignacionSeleccionadaParaReemplazo;
    estado.textContent = "Enviando pedido...";

    db.collection("reemplazos").add({
      fecha: data.fecha,
      hora: data.hora,
      rol: data.rol,
      nombre: data.nombre,
      pin: data.pin,
      creadoEn: new Date().toISOString(),
      estado: "pendiente"
    })
    .then(() => {
      estado.textContent = "‚úÖ Pedido enviado. Abriendo WhatsApp...";
      estado.classList.add("ok");

      // Abre WhatsApp del ACOMODADOR hacia tu n√∫mero (coordinador)
      const msg = buildMensajeReemplazoParaWa(data);
      abrirWhatsAppANumero(COORDINADOR_WA, msg);
    })
    .catch((error) => {
      console.error("Error guardando reemplazo:", error);
      estado.textContent = "‚ùå Error al guardar el pedido.";
      estado.classList.add("err");
    });
  }

  // ================== Reemplazos (Coordinador) ==================
  function escucharReemplazosCoordinador() {
    if (!firebaseHabilitado || !db) return;

    db.collection("reemplazos").orderBy("fecha").onSnapshot((snapshot) => {
      const tbody = document.getElementById("tablaReemplazos");
      const sinEl = document.getElementById("sinReemplazos");
      tbody.innerHTML = "";

      if (snapshot.empty) { sinEl.style.display = "block"; return; }
      sinEl.style.display = "none";

      snapshot.forEach((doc) => {
        const data = doc.data();
        const tr = document.createElement("tr");

        const tdFecha = document.createElement("td"); tdFecha.textContent = formatearFechaConDia(data.fecha || ""); tr.appendChild(tdFecha);
        const tdHora = document.createElement("td"); tdHora.textContent = data.hora || ""; tr.appendChild(tdHora);

        const tdRol = document.createElement("td");
        tdRol.textContent = data.rol || "";
        if (data.rol === "Entrada") tdRol.classList.add("rol-entrada");
        if (data.rol === "Auditorio") tdRol.classList.add("rol-auditorio");
        tr.appendChild(tdRol);

        const tdNombre = document.createElement("td"); tdNombre.textContent = data.nombre || ""; tr.appendChild(tdNombre);
        const tdPin = document.createElement("td"); tdPin.textContent = data.pin || ""; tr.appendChild(tdPin);

        const tdAcc = document.createElement("td");
        const btnCopiar = document.createElement("button");
        btnCopiar.type = "button";
        btnCopiar.className = "btn-secondary btn-small";
        btnCopiar.textContent = "üìã Copiar";
        btnCopiar.onclick = () => copiarAlPortapapeles(buildMensajeReemplazoParaWa(data));
        tdAcc.appendChild(btnCopiar);
        tr.appendChild(tdAcc);

        tbody.appendChild(tr);
      });
    });
  }

  // ================== Notificaciones locales ==================
  function solicitarPermisoNotificaciones() {
    if (!("Notification" in window)) return;
    if (Notification.permission === "default") Notification.requestPermission().then((perm) => console.log("Permiso notificaciones:", perm));
  }

  function programarNotificacionesAsignaciones(asignaciones) {
    if (!("Notification" in window)) return;
    if (Notification.permission !== "granted") return;

    timersNotificaciones.forEach((id) => clearTimeout(id));
    timersNotificaciones = [];

    const hoyStr = new Date().toISOString().slice(0, 10);
    asignaciones.forEach((asig) => {
      if (asig.fecha !== hoyStr) return;
      if (!asig.hora) return;

      const partes = asig.hora.split(":");
      if (partes.length < 2) return;

      const hora = parseInt(partes[0], 10);
      const minuto = parseInt(partes[1], 10);

      const fechaNoti = new Date();
      fechaNoti.setHours(hora, minuto, 0, 0);

      const diff = fechaNoti.getTime() - Date.now();
      if (diff <= 0) return;
      if (diff > 24 * 60 * 60 * 1000) return;

      const timerId = setTimeout(() => {
        new Notification("Recordatorio de asignaci√≥n", { body: `${asig.hora} - ${asig.rol} (${asig.nombre || ""})` });
      }, diff);

      timersNotificaciones.push(timerId);
    });
  }
  </script>
</body>
</html>
